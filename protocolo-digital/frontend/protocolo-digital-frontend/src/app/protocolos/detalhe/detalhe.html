<div *ngIf="protocolo">
  <h2>Protocolo {{protocolo.numero}}</h2>
  <p>Status: {{protocolo.status}}</p>
  <div *ngIf="editando">
    <label>
      Descrição
      <input [(ngModel)]="edicao.descricao" name="desc">
    </label>
    <label>
      Valor
      <input [(ngModel)]="edicao.valorTotal" name="val" type="number" step="0.01">
    </label>
    <app-upload (filesChange)="arquivosSelecionados($event)"></app-upload>
    <button (click)="salvarEdicao()">Salvar</button>
    <button (click)="editando=false">Cancelar</button>
  </div>
  <div *ngIf="!editando">
    <p>{{protocolo.descricao}}</p>
    <p>Valor: {{protocolo.valorTotal}}</p>
    <button *ngIf="protocolo.status==='Pendente' || protocolo.status==='EmCorrecao' || (protocolo.status==='Recusado' && usuarioId===protocolo.usuarioCriador.id)" (click)="editar()">Editar</button>
  </div>

  <div *ngIf="protocolo.anexos?.length">
    <h3>Anexos</h3>
    <ul>
      <li *ngFor="let a of protocolo.anexos">
        <a [href]="'/uploads/' + a.caminho" target="_blank">{{a.nomeArquivo}}</a>
        <button (click)="remover(a.id)">Remover</button>
      </li>
    </ul>
  </div>

  <ul class="stepper">
    <li *ngFor="let f of fluxos" [class.active]="protocolo.etapaAtual === f.ordem" [class.recusado]="recusaOrdem === f.ordem">
      {{f.ordem}} - {{f.setor.nome}}
    </li>
  </ul>

  <button *ngIf="podeExecutarAcao" (click)="abrir('aprovar')">Aprovar</button>
  <button *ngIf="!podeExecutarAcao" disabled [title]="motivoBloqueio">Aprovar</button>
  <button (click)="abrir('rejeitar')" [disabled]="!podeExecutarAcao" [title]="!podeExecutarAcao ? motivoBloqueio : null">Rejeitar</button>
  <button (click)="abrir('corrigir')" [disabled]="!podeExecutarAcao" [title]="!podeExecutarAcao ? motivoBloqueio : null">Correção</button>

  <div class="modal" *ngIf="mostrarModal">
    <div class="modal-content">
      <label>
        Justificativa
        <textarea [(ngModel)]="justificativa"></textarea>
      </label>
      <button (click)="executar()" [disabled]="loading">Enviar</button>
      <span *ngIf="loading">Enviando...</span>
    </div>
  </div>

  <div *ngIf="historico?.length">
    <h3>Histórico de Ações</h3>
    <ul>
      <li *ngFor="let h of historico">
        {{h.dataHora | date:'short'}} - {{h.usuario?.nome}} - {{h.acao}} - {{h.observacao}}
      </li>
    </ul>
  </div>
</div>
